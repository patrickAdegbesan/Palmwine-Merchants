{% extends 'base.html' %}
{% load static %}



{% block title %}Book Your Experience - Palmwine Merchants & Flames{% endblock %}

{% block extra_css %}
<meta name="paystack-public-key" content="{{ paystack_public_key }}" />
{% endblock %}

{% block content %}
    <section class="hero small">
      <div class="hero-inner">
        <h1><span class="display">Get an Instant Quote</span></h1>
        <p class="tagline">Enter your event details. We’ll calculate line items, tax, delivery and deposit — ready to print or share.</p>
      </div>
    </section>

    <section class="section" id="quote">
      <div class="container">
        <h2>Booking Details</h2>
        <p class="lead">Tell us about your event. Prices are estimates — we’ll confirm on WhatsApp.</p>

        <form id="quote-form" class="form" autocomplete="on">
          <div class="two-col" style="align-items:flex-start">
            <div>
              <label for="clientName">Full Name</label>
              <input id="clientName" name="clientName" type="text" placeholder="e.g. Ade Ola" required />

              <label for="phone">WhatsApp Number</label>
              <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="e.g. +234 803 123 4567" required />

              <label for="email">Email (optional)</label>
              <input id="email" name="email" type="email" placeholder="you@example.com" />

              <label for="date">Event Date</label>
              <input id="date" name="date" type="date" required />
              <div id="availability-status" class="availability-status" style="display: none; margin-top: 5px; padding: 8px; border-radius: 6px; font-size: 14px;"></div>

              <label for="eventType">Event Type</label>
              <select id="eventType" name="eventType" required>
                <option value="Private">Private</option>
                <option value="Corporate">Corporate</option>
                <option value="Wedding">Wedding</option>
                <option value="Birthday">Birthday</option>
                <option value="Festival">Festival</option>
              </select>

              <label for="venue">Venue / Address</label>
              <textarea id="venue" name="venue" rows="3" placeholder="Venue name / address" required></textarea>

              <label for="guests">Expected Guests</label>
              <input id="guests" name="guests" type="number" min="10" step="1" placeholder="e.g. 80" required />
            </div>

            <div>
              <fieldset class="radio-fieldset" style="border:1px solid #eee;padding:12px;border-radius:12px;margin-bottom:12px">
                <legend style="padding:0 8px;font-weight:700;color:var(--leaf)">Service Package</legend>
                <label class="radio-label"><input type="radio" name="basePackage" value="palmwine" required /> Palmwine Service</label>
                <label class="radio-label"><input type="radio" name="basePackage" value="cocktails" /> Palmwine Cocktails</label>
                <label class="radio-label"><input type="radio" name="basePackage" value="flame" /> Open‑Flame Cuisine (WhatsApp quote)</label>
                <label class="radio-label"><input type="radio" name="basePackage" value="full" /> Full Experience — Palmwine + Flame (WhatsApp quote)</label>
                <small class="muted">Selecting Open‑Flame or Full Experience will open WhatsApp for manual pricing.</small>
              </fieldset>

              <label for="distanceKm">Delivery Distance (km from Lekki I)</label>
              <input id="distanceKm" name="distanceKm" type="number" min="0" step="1" placeholder="e.g. 12" />

              <div class="btn-row">
                <button class="btn primary" type="submit"><i class="fa-solid fa-calculator"></i> Compute Quote</button>
                <button class="btn ghost" type="reset"><i class="fa-solid fa-rotate"></i> Reset</button>
              </div>
              <p class="form-note"> Delivery is distance‑based. A deposit is required to secure the date.</p>
            </div>
          </div>
        </form>

        <div id="invoice" class="invoice" style="display:none" aria-live="polite">
                      <!-- Payment Status Section -->
            <div id="payment-status-section" style="display:none;">
              <div class="success-message" style="text-align: center; padding: 20px; background: #f8fff8; border: 1px solid #2c5530; border-radius: 8px; margin: 20px 0;">
                <i class="fa-solid fa-circle-check" style="color: #2c5530; font-size: 48px;"></i>
                <h2 id="payment-success-title" style="color: #2c5530; margin: 10px 0;">Payment Successful!</h2>
                <p id="payment-success-message" class="lead">Your payment has been confirmed.</p>
                <div class="btn-row" style="margin-top: 20px;">
                  <button id="btn-download-receipt" class="btn accent"><i class="fa-solid fa-download"></i> Download Receipt</button>
                  <a id="btn-whatsapp-confirm" class="btn secondary" href="#" target="_blank"><i class="fa-brands fa-whatsapp"></i> Confirm on WhatsApp</a>
                </div>
                <p class="form-note" style="margin-top: 10px;">A copy of your receipt will also be sent to your email if provided.</p>
              </div>
            </div>
          <img src="{% static 'img/comp1_logo.png' %}" alt="" class="invoice-watermark" aria-hidden="true" />
          <div class="invoice-head">
            <div>
              <img src="{% static 'img/comp2_logo.png' %}" alt="Palmwine Merchants & Flames logo" class="invoice-logo" />
              <h3 style="margin:0">Palmwine Merchants & Flames</h3>
              <small class="muted">Lagos, Nigeria · +234 803 949 0349 · Palmwinemerchants@gmail.com</small>
            </div>
            <div class="invoice-meta">
              <div><strong>Quote #</strong>: <span id="inv-id">—</span></div>
              <div><strong>Date</strong>: <span id="inv-date">—</span></div>
            </div>
          </div>

          <div class="invoice-party">
            <div>
              <strong>Billed To</strong>
              <div id="inv-client">—</div>
              <div class="muted" id="inv-contact">—</div>
            </div>
            <div>
              <strong>Event</strong>
              <div id="inv-event">—</div>
              <div class="muted" id="inv-venue">—</div>
            </div>
          </div>

          <div class="table-wrap">
            <table class="invoice-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Qty</th>
                  <th>Unit</th>
                  <th class="ta-right">Amount</th>
                </tr>
              </thead>
              <tbody id="inv-rows"></tbody>
            </table>
          </div>

          <div class="totals">
            <div></div>
            <ul>
              <li><span>Service Cost</span><strong class="money" id="inv-subtotal">₦0</strong></li>
              <li><span>Delivery</span><strong class="money" id="inv-delivery">₦0</strong></li>
              <li class="grand"><span>Total Amount</span><strong class="money" id="inv-total">₦0</strong></li>
              <li class="accent"><span>Deposit (40%)</span><strong class="money" id="inv-deposit">₦0</strong></li>
            </ul>
          </div>

          <div class="btn-row print-hide">
            <button class="btn primary" id="btn-pay-deposit" type="button"><i class="fa-solid fa-credit-card"></i> Pay Deposit (₦<span id="deposit-amount">0</span>)</button>
            <button class="btn accent" id="btn-pay-full" type="button"><i class="fa-solid fa-credit-card"></i> Pay Full Amount (₦<span id="full-amount">0</span>)</button>
            <a class="btn secondary" id="btn-share" href="#" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> Share Quote</a>
          </div>

          <p class="form-note">This is an estimate. Availability is not guaranteed until deposit is received. Prices may vary with final brief and logistics.</p>
        </div>
      </div>
    </section>
{% endblock %}

{% block extra_js %}
<!-- Pre-load Paystack -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Check availability when date changes
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    const availabilityStatus = document.getElementById('availability-status');
    
    // Set minimum date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateInput.min = tomorrow.toISOString().split('T')[0];
    
    dateInput.addEventListener('change', async function() {
        const selectedDate = this.value;
        if (!selectedDate) return;
        
        availabilityStatus.style.display = 'block';
        availabilityStatus.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking availability...';
        availabilityStatus.className = 'availability-status checking';
        
        try {
            const response = await fetch('/api/check-availability/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    event_date: selectedDate
                })
            });
            
            const data = await response.json();
            
            if (data.available) {
                availabilityStatus.innerHTML = '<i class="fa-solid fa-check-circle"></i> ' + data.message;
                availabilityStatus.className = 'availability-status available';
            } else {
                availabilityStatus.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> ' + data.message;
                availabilityStatus.className = 'availability-status unavailable';
            }
        } catch (error) {
            availabilityStatus.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Error checking availability';
            availabilityStatus.className = 'availability-status error';
        }
    });
});
</script>

<!-- Add loading indicator styles -->
<style>
.availability-status {
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    border-radius: 6px;
    font-size: 14px;
}

.availability-status.checking {
    color: #6c757d;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
}

.availability-status.available {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}

.availability-status.unavailable {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}

.availability-status.error {
    color: #856404;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #2c5530;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
.loading-text {
    margin-top: 10px;
    color: #2c5530;
    font-weight: bold;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<!-- Add loading overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing payment...</div>
</div>

<script src="{% static 'payment.js' %}"></script>
<script>
// Function to load Paystack script
function loadPaystackScript() {
    return new Promise((resolve, reject) => {
        if (typeof PaystackPop !== 'undefined') {
            console.log('Paystack already loaded');
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://js.paystack.co/v1/inline.js';
        script.async = true;
        script.onload = () => {
            console.log('Paystack script loaded successfully');
            resolve();
        };
        script.onerror = (error) => {
            console.error('Failed to load Paystack script:', error);
            reject(error);
        };
        document.head.appendChild(script);
    });
}

document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Load Paystack first
        await loadPaystackScript();
        
        // Then initialize payment handler
        await PaymentHandler.init();
    } catch (error) {
        console.error('Initialization error:', error);
        // You may surface this to the user if desired
        // alert('Failed to initialize payment system. Please refresh and try again.');
    }

    // Add loading indicator with status updates
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = loadingOverlay.querySelector('.loading-text');
    const originalStartPayment = PaymentHandler.startPayment;
    
    // Add check availability to the booking form
    const bookingDateInput = document.getElementById('date');
    if (bookingDateInput) {
        bookingDateInput.addEventListener('change', async function() {
            const date = this.value;
            if (!date) return;
            
            try {
                // Show checking status
                const feedbackDiv = this.nextElementSibling && this.nextElementSibling.classList.contains('input-feedback') 
                    ? this.nextElementSibling 
                    : document.createElement('div');
                
                if (!feedbackDiv.classList.contains('input-feedback')) {
                    feedbackDiv.className = 'input-feedback mt-1';
                    feedbackDiv.style.fontSize = '0.85rem';
                    this.parentNode.insertBefore(feedbackDiv, this.nextSibling);
                }
                
                feedbackDiv.textContent = 'Checking availability...';
                feedbackDiv.className = 'input-feedback mt-1 text-info';
                
                const response = await fetch(`/api/check-availability/?date=${date}`);
                const data = await response.json();
                
                if (data.available) {
                    feedbackDiv.textContent = 'Date is available!';
                    feedbackDiv.className = 'input-feedback mt-1 text-success';
                    this.setCustomValidity('');
                    document.getElementById('calculate-btn').disabled = false;
                } else {
                    feedbackDiv.textContent = data.message || 'Date is unavailable.';
                    feedbackDiv.className = 'input-feedback mt-1 text-danger';
                    this.setCustomValidity('Date unavailable');
                    document.getElementById('calculate-btn').disabled = true;
                }
            } catch (error) {
                console.error('Error checking availability:', error);
            }
        });
    }

    PaymentHandler.startPayment = async function(type) {
        try {
            loadingOverlay.style.display = 'flex';
            loadingText.textContent = 'Validating details...';
            
            // Check customer info
            if (!this.validateCustomerInfo()) {
                throw new Error('Please fill in required information');
            }
            
            loadingText.textContent = 'Initializing payment...';
            const paystackReady = await this.setupPaystack();
            if (!paystackReady) {
                throw new Error('Payment system not ready');
            }
            
            loadingText.textContent = 'Starting payment...';
            await originalStartPayment.call(this, type);
        } catch (error) {
            console.error('Payment process error:', error);
            alert(error.message);
        } finally {
            loadingOverlay.style.display = 'none';
            loadingText.textContent = 'Initializing payment...';
        }
    };

    // Update deposit and full amount display when quote is calculated
    const quoteForm = document.getElementById('quote-form');
    if (quoteForm) {
        quoteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            PaymentHandler.getAmounts();
        });
    }
});
</script>
{% endblock %}
