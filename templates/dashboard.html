{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .dashboard {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    /* Improved Stats Cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: linear-gradient(135deg, #2c5530, #3d7744);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin: 15px 0;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .stat-label {
        font-size: 1em;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Quick Stats Section */
    .quick-stats {
        display: flex;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    .stat-item {
        background: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        flex: 1;
        min-width: 200px;
        text-align: center;
    }
    .stat-item .stat-label {
        color: #666;
        font-size: 0.9em;
        display: block;
        margin-bottom: 5px;
    }
    .stat-item .stat-value {
        color: #2c5530;
        font-size: 1.5em;
        font-weight: bold;
    }

    /* Enhanced Table Styling */
    .table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .table th {
        background: #f8f9fa;
        color: #2c5530;
        font-weight: 600;
        padding: 15px;
        border-bottom: 2px solid #e9ecef;
    }
    .table td {
        padding: 12px 15px;
        vertical-align: middle;
    }
    .table tbody tr:hover {
        background: #f8f9fa;
    }

    /* Improved Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .status-badge::before {
        content: '';
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .status-pending { 
        background: #fff3cd; 
        color: #856404; 
    }
    .status-pending::before { 
        background: #ffc107; 
    }
    .status-confirmed { 
        background: #d4edda; 
        color: #155724; 
    }
    .status-confirmed::before { 
        background: #28a745; 
    }
    .status-cancelled { 
        background: #f8d7da; 
        color: #721c24; 
    }
    .status-cancelled::before { 
        background: #dc3545; 
    }
    .status-completed { 
        background: #cce5ff; 
        color: #004085; 
    }
    .status-completed::before { 
        background: #007bff; 
    }

    /* Enhanced Action Buttons */
    .btn-action {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9em;
    }
    .btn-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-action i {
        font-size: 1.1em;
    }
    .btn-primary {
        background: #2c5530;
        color: white;
    }
    .btn-primary:hover {
        background: #3d7744;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .btn-danger:hover {
        background: #c82333;
    }
    .btn-warning {
        background: #ffc107;
        color: #000;
    }
    .btn-warning:hover {
        background: #e0a800;
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    .btn-success:hover {
        background: #218838;
    }

    /* Improved Search and Filters */
    .filters {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    .search-box {
        padding: 10px 15px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        width: 300px;
        transition: all 0.2s;
    }
    .search-box:focus {
        border-color: #2c5530;
        box-shadow: 0 0 0 2px rgba(44,85,48,0.1);
        outline: none;
    }
    .filter-select {
        padding: 10px 15px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        background: white;
        min-width: 150px;
    }
    .filter-select:focus {
        border-color: #2c5530;
        box-shadow: 0 0 0 2px rgba(44,85,48,0.1);
        outline: none;
    }

    /* Enhanced Modal Styling */
    .modal-content {
        background: white;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .modal h3 {
        color: #2c5530;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
    }
    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        transition: all 0.2s;
    }
    .form-control:focus {
        border-color: #2c5530;
        box-shadow: 0 0 0 2px rgba(44,85,48,0.1);
        outline: none;
    }

    /* Loading States */
    .loading {
        position: relative;
        opacity: 0.7;
        pointer-events: none;
    }
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 30px;
        height: 30px;
        margin: -15px 0 0 -15px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2c5530;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Navigation */
    .nav-tabs {
        border-bottom: 2px solid #2c5530;
        margin-bottom: 20px;
    }
    .nav-tabs .nav-link {
        color: #666;
        border: none;
        padding: 10px 20px;
        margin-right: 5px;
        border-radius: 4px 4px 0 0;
    }
    .nav-tabs .nav-link.active {
        background: #2c5530;
        color: white;
    }
    
    /* Cards */
    .dashboard-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 15px;
        padding: 20px;
    }
    
    /* Stats */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .stat-card {
        background: linear-gradient(135deg, #2c5530, #3d7744);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
    }
    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    /* Tables */
    .table-responsive {
        margin-top: 20px;
    }
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    .table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    .table td {
        padding: 12px;
        border-top: 1px solid #dee2e6;
    }
    
    /* Filters and Search */
    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .search-box {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 250px;
    }
    .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
    }
    
    /* Actions */
    .btn-action {
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        margin-right: 5px;
    }
    .btn-primary {
        background: #2c5530;
        color: white;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .btn-warning {
        background: #ffc107;
        color: #000;
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    /* Status badges */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-confirmed { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    .status-completed { background: #cce5ff; color: #004085; }
    .status-verified { background: #d4edda; color: #155724; }
    .status-unverified { background: #fff3cd; color: #856404; }
    
    /* Forms */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal.show {
        display: flex;
    }
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }
    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .modal-footer {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dashboard</h1>
        <div class="user-controls">
            <span class="mr-3">Welcome, {{ user.username }}</span>
            <a href="{% url 'pw_website:logout' %}" class="btn-action btn-danger">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>
    
    <!-- Stats Overview -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-number" id="totalBookings">0</div>
            <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalEvents">0</div>
            <div class="stat-label">Active Events</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalTickets">0</div>
            <div class="stat-label">Tickets Sold</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalRevenue">â‚¦0</div>
            <div class="stat-label">Revenue</div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#bookings">Bookings</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#events">Events</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#tickets">Tickets</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Bookings Tab -->
        <div class="tab-pane fade show active" id="bookings">
            <div class="filters">
                <button class="btn-action btn-primary" onclick="showAddBookingModal()">Add Booking</button>
                <input type="text" id="bookingSearch" class="search-box" placeholder="Search bookings...">
                <select id="bookingStatusFilter" class="filter-select">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="bookingDateFilter" class="filter-select">
                    <option value="">All Dates</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="future">Future</option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table" id="bookingsTable">
                    <thead>
                        <tr>
                            <th>Quote ID</th>
                            <th>Client</th>
                            <th>Event Type</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Events Tab -->
        <div class="tab-pane fade" id="events">
            <div class="filters">
                <button class="btn-action btn-primary" onclick="showAddEventModal()">Add Event</button>
                <input type="text" id="eventSearch" class="search-box" placeholder="Search events...">
                <select id="eventTypeFilter" class="filter-select">
                    <option value="">All Types</option>
                    <option value="bush_party">Bush Party</option>
                    <option value="corporate">Corporate Event</option>
                    <option value="private">Private Event</option>
                    <option value="wedding">Wedding</option>
                    <option value="festival">Festival</option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table" id="eventsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Capacity</th>
                            <th>Available</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Quick Stats for Events -->
        <div class="quick-stats">
            <div class="stat-item">
                <span class="stat-label">Total Events</span>
                <span class="stat-value" id="totalEventsCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Upcoming Events</span>
                <span class="stat-value" id="upcomingEventsCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Capacity</span>
                <span class="stat-value" id="totalCapacity">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Available Tickets</span>
                <span class="stat-value" id="availableTickets">0</span>
            </div>
        </div>

        <!-- Tickets Tab -->
        <div class="tab-pane fade" id="tickets">
            <div class="filters">
                <button class="btn-action btn-primary" onclick="showAddTicketModal()">Add Ticket</button>
                <input type="text" id="ticketSearch" class="search-box" placeholder="Search tickets...">
                <select id="ticketStatusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="verified">Verified</option>
                    <option value="unverified">Unverified</option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table" id="ticketsTable">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Event</th>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>Purchase Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Add/Edit Booking Modal -->
<div class="modal" id="bookingModal">
    <div class="modal-content">
        <h3 id="bookingModalTitle">Add Booking</h3>
        <form id="bookingForm">
            <input type="hidden" id="bookingId">
            <div class="form-group">
                <label>Client Name</label>
                <input type="text" class="form-control" id="clientName" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="form-control" id="phone" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-control" id="email">
            </div>
            <div class="form-group">
                <label>Event Type</label>
                <select class="form-control" id="eventType" required>
                    <option value="wedding">Wedding</option>
                    <option value="birthday">Birthday</option>
                    <option value="corporate">Corporate Event</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Event Date</label>
                <input type="date" class="form-control" id="eventDate" required>
            </div>
            <div class="form-group">
                <label>Venue</label>
                <input type="text" class="form-control" id="venue" required>
            </div>
            <div class="form-group">
                <label>Number of Guests</label>
                <input type="number" class="form-control" id="guests" min="1" required>
            </div>
            <div class="form-group">
                <label>Package Type</label>
                <select class="form-control" id="packageType" required>
                    <option value="palmwine">Palmwine Service</option>
                    <option value="cocktails">Palmwine Cocktails</option>
                    <option value="flame">Open-Flame Cuisine</option>
                    <option value="full">Full Experience</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-action" onclick="closeModal('bookingModal')">Cancel</button>
                <button type="submit" class="btn-action btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Event Modal -->
<div class="modal" id="eventModal">
    <div class="modal-content">
        <h3 id="eventModalTitle">Add Event</h3>
        <form id="eventForm">
            <input type="hidden" id="eventId">
            <div class="form-group">
                <label>Event Name</label>
                <input type="text" class="form-control" id="eventName" required>
            </div>
            <div class="form-group">
                <label>Event Type</label>
                <select class="form-control" id="eventTypeSelect" required>
                    <option value="bush_party">Bush Party</option>
                    <option value="corporate">Corporate Event</option>
                    <option value="private">Private Event</option>
                    <option value="wedding">Wedding</option>
                    <option value="festival">Festival</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date & Time</label>
                <input type="datetime-local" class="form-control" id="eventDateTime" required>
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" class="form-control" id="eventLocation" required>
            </div>
            <div class="form-group">
                <label>Maximum Capacity</label>
                <input type="number" class="form-control" id="maxCapacity" min="1" required>
            </div>
            <div class="form-group">
                <label>Price per Ticket</label>
                <input type="number" class="form-control" id="ticketPrice" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" id="eventDescription" rows="3" required></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-action" onclick="closeModal('eventModal')">Cancel</button>
                <button type="submit" class="btn-action btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Ticket Modal -->
<div class="modal" id="ticketModal">
    <div class="modal-content">
        <h3 id="ticketModalTitle">Add Ticket</h3>
        <form id="ticketForm">
            <input type="hidden" id="ticketId">
            <div class="form-group">
                <label>Event</label>
                <select class="form-control" id="ticketEvent" required></select>
            </div>
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" class="form-control" id="ticketCustomerName" required>
            </div>
            <div class="form-group">
                <label>Customer Email</label>
                <input type="email" class="form-control" id="ticketCustomerEmail" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="form-control" id="ticketPhone">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" class="form-control" id="ticketQuantity" min="1" value="1" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-action" onclick="closeModal('ticketModal')">Cancel</button>
                <button type="submit" class="btn-action btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Utility functions
const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-NG', {
        style: 'currency',
        currency: 'NGN'
    }).format(amount);
};

const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('en-NG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
};

// Modal functions
function showModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Dashboard stats
async function loadDashboardStats() {
    try {
        const [bookingsResponse, eventsResponse, ticketsResponse] = await Promise.all([
            fetch('/api/bookings/'),
            fetch('/api/events/'),
            fetch('/api/tickets/')
        ]);

        const bookings = await bookingsResponse.json();
        const events = await eventsResponse.json();
        const tickets = await ticketsResponse.json();

        // Calculate totals
        const totalBookings = bookings.length;
        const totalEvents = events.filter(e => new Date(e.date) >= new Date()).length;
        const totalTickets = tickets.length;
        const totalRevenue = bookings.reduce((sum, b) => sum + b.total, 0);

        // Update stats display
        document.getElementById('totalBookings').textContent = totalBookings;
        document.getElementById('totalEvents').textContent = totalEvents;
        document.getElementById('totalTickets').textContent = totalTickets;
        document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

// Bookings
async function loadBookings(filters = {}) {
    try {
        const response = await fetch('/api/bookings/');
        let bookings = await response.json();

        // Apply filters
        if (filters.search) {
            const search = filters.search.toLowerCase();
            bookings = bookings.filter(b => 
                b.client_name.toLowerCase().includes(search) ||
                b.quote_id.toLowerCase().includes(search)
            );
        }

        if (filters.status) {
            bookings = bookings.filter(b => b.status === filters.status);
        }

        if (filters.dateFilter) {
            const now = new Date();
            bookings = bookings.filter(b => {
                const bookingDate = new Date(b.event_date);
                switch(filters.dateFilter) {
                    case 'today':
                        return bookingDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return bookingDate >= weekStart && bookingDate <= weekEnd;
                    case 'month':
                        return bookingDate.getMonth() === now.getMonth() &&
                               bookingDate.getFullYear() === now.getFullYear();
                    case 'future':
                        return bookingDate >= now;
                    default:
                        return true;
                }
            });
        }

        // Update table
        const tbody = document.getElementById('bookingsTableBody');
        tbody.innerHTML = bookings.map(booking => `
            <tr>
                <td>${booking.quote_id}</td>
                <td>${booking.client_name}</td>
                <td>${booking.event_type}</td>
                <td>${formatDate(booking.event_date)}</td>
                <td><span class="status-badge status-${booking.status.toLowerCase()}">${booking.status}</span></td>
                <td>${formatCurrency(booking.total)}</td>
                <td>
                    <button class="btn-action btn-warning" onclick="editBooking('${booking.id}')">Edit</button>
                    <button class="btn-action btn-danger" onclick="deleteBooking('${booking.id}')">Delete</button>
                    ${booking.status === 'pending' ? `
                        <button class="btn-action btn-success" onclick="updateBookingStatus('${booking.id}', 'confirmed')">Confirm</button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading bookings:', error);
    }
}

// Events
async function loadEvents(filters = {}) {
    try {
        document.getElementById('eventsTableBody').classList.add('loading');
        const response = await fetch('/api/events/');
        let events = await response.json();

        // Apply filters
        if (filters.search) {
            const search = filters.search.toLowerCase();
            events = events.filter(e => 
                e.name.toLowerCase().includes(search) ||
                e.location.toLowerCase().includes(search) ||
                e.event_type.toLowerCase().includes(search)
            );
        }

        if (filters.type) {
            events = events.filter(e => e.event_type === filters.type);
        }

        // Calculate stats
        const now = new Date();
        const totalEvents = events.length;
        const upcomingEvents = events.filter(e => new Date(e.date) >= now).length;
        const totalCapacity = events.reduce((sum, e) => sum + e.max_capacity, 0);
        const availableTickets = events.reduce((sum, e) => sum + e.tickets_available, 0);

        // Update stats
        document.getElementById('totalEventsCount').textContent = totalEvents;
        document.getElementById('upcomingEventsCount').textContent = upcomingEvents;
        document.getElementById('totalCapacity').textContent = totalCapacity.toLocaleString();
        document.getElementById('availableTickets').textContent = availableTickets.toLocaleString();

        // Update table
        const tbody = document.getElementById('eventsTableBody');
        tbody.innerHTML = events.map(event => {
            const eventDate = new Date(event.date);
            const isUpcoming = eventDate >= now;
            const availablePercentage = ((event.tickets_available / event.max_capacity) * 100).toFixed(0);
            const statusClass = isUpcoming ? 'status-confirmed' : 'status-completed';
            const statusText = isUpcoming ? 'Upcoming' : 'Past';

            return `
                <tr>
                    <td>
                        <div class="event-name">${event.name}</div>
                        <small class="text-muted">${event.description || ''}</small>
                    </td>
                    <td><span class="badge bg-info">${event.event_type.replace('_', ' ').toUpperCase()}</span></td>
                    <td>
                        <div>${formatDate(event.date)}</div>
                        <small class="text-muted">${eventDate.toLocaleTimeString()}</small>
                    </td>
                    <td>${event.location}</td>
                    <td>${event.max_capacity.toLocaleString()}</td>
                    <td>
                        <div class="availability-bar">
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: ${availablePercentage}%"></div>
                            </div>
                            <small>${event.tickets_available} available</small>
                        </div>
                    </td>
                    <td>${formatCurrency(event.price_per_ticket)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn-action btn-warning" onclick="editEvent('${event.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-primary" onclick="viewEventDetails('${event.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-danger" onclick="deleteEvent('${event.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading events:', error);
    }
}

// Tickets
async function loadTickets(filters = {}) {
    try {
        const response = await fetch('/api/tickets/');
        let tickets = await response.json();

        // Apply filters
        if (filters.search) {
            const search = filters.search.toLowerCase();
            tickets = tickets.filter(t => 
                t.ticket_id.toLowerCase().includes(search) ||
                t.customer_name.toLowerCase().includes(search)
            );
        }

        if (filters.status) {
            tickets = tickets.filter(t => 
                filters.status === 'verified' ? t.verified : !t.verified
            );
        }

        // Update table
        const tbody = document.getElementById('ticketsTableBody');
        tbody.innerHTML = tickets.map(ticket => `
            <tr>
                <td>${ticket.ticket_id}</td>
                <td>${ticket.event?.name || 'N/A'}</td>
                <td>${ticket.customer_name}</td>
                <td><span class="status-badge status-${ticket.verified ? 'verified' : 'unverified'}">${ticket.verified ? 'Verified' : 'Unverified'}</span></td>
                <td>${formatDate(ticket.purchased_at)}</td>
                <td>
                    <button class="btn-action btn-warning" onclick="editTicket('${ticket.id}')">Edit</button>
                    <button class="btn-action btn-danger" onclick="deleteTicket('${ticket.id}')">Delete</button>
                    ${!ticket.verified ? `
                        <button class="btn-action btn-success" onclick="verifyTicket('${ticket.id}')">Verify</button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading tickets:', error);
    }
}

// Event handlers
document.getElementById('bookingSearch').addEventListener('input', (e) => {
    loadBookings({ search: e.target.value });
});

document.getElementById('bookingStatusFilter').addEventListener('change', (e) => {
    loadBookings({ status: e.target.value });
});

document.getElementById('bookingDateFilter').addEventListener('change', (e) => {
    loadBookings({ dateFilter: e.target.value });
});

document.getElementById('eventSearch').addEventListener('input', (e) => {
    loadEvents({ search: e.target.value });
});

document.getElementById('eventTypeFilter').addEventListener('change', (e) => {
    loadEvents({ type: e.target.value });
});

document.getElementById('ticketSearch').addEventListener('input', (e) => {
    loadTickets({ search: e.target.value });
});

document.getElementById('ticketStatusFilter').addEventListener('change', (e) => {
    loadTickets({ status: e.target.value });
});

// Form submissions
document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = {
        client_name: document.getElementById('clientName').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        event_type: document.getElementById('eventType').value,
        event_date: document.getElementById('eventDate').value,
        venue: document.getElementById('venue').value,
        guests: parseInt(document.getElementById('guests').value),
        package_type: document.getElementById('packageType').value
    };

    const bookingId = document.getElementById('bookingId').value;
    const method = bookingId ? 'PUT' : 'POST';
    const url = bookingId ? `/api/bookings/${bookingId}/` : '/api/bookings/';

    try {
        const response = await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            closeModal('bookingModal');
            loadBookings();
            loadDashboardStats();
        } else {
            alert('Error saving booking');
        }
    } catch (error) {
        console.error('Error saving booking:', error);
        alert('Error saving booking');
    }
});

// Error handling function
function showError(message, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            ${message}
            <button type="button" class="btn-retry" onclick="retryLoad('${containerId}')">
                <i class="fas fa-sync"></i> Retry
            </button>
        </div>
    `;
}

// Retry loading function
async function retryLoad(containerId) {
    switch(containerId) {
        case 'bookingsTableBody':
            await loadBookings();
            break;
        case 'eventsTableBody':
            await loadEvents();
            break;
        case 'ticketsTableBody':
            await loadTickets();
            break;
    }
}

// View event details function
function viewEventDetails(eventId) {
    // Implementation for viewing event details
    console.log('Viewing event:', eventId);
    // Add your implementation here
}

// Refresh data periodically
let refreshInterval;
function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        const activeTab = document.querySelector('.nav-tabs .active').getAttribute('href');
        switch(activeTab) {
            case '#bookings':
                loadBookings();
                break;
            case '#events':
                loadEvents();
                break;
            case '#tickets':
                loadTickets();
                break;
        }
    }, 60000); // Refresh every minute
}

function stopAutoRefresh() {
    clearInterval(refreshInterval);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
    // Load initial data
    Promise.all([
        loadDashboardStats(),
        loadBookings(),
        loadEvents(),
        loadTickets()
    ]).catch(error => {
        console.error('Error loading dashboard:', error);
        showError('Failed to load dashboard data. Please try again.', 'bookingsTableBody');
    });

    // Initialize Bootstrap tabs with loading indicators
    $('.nav-tabs a').on('click', function(e) {
        e.preventDefault();
        $(this).tab('show');
        
        const targetId = $(this).attr('href').substring(1);
        document.getElementById(targetId).classList.add('loading');
        
        switch(targetId) {
            case 'bookings':
                loadBookings();
                break;
            case 'events':
                loadEvents();
                break;
            case 'tickets':
                loadTickets();
                break;
        }
    });

    // Start auto-refresh
    startAutoRefresh();
});

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
